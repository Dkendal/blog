<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Capture paths from a Kitty window in Neovim - Digital Janitorial Services</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Tired of skimming through buffer output, looking for a path? I am! I spent relaxing day at the cottage hacking together a Lua plugin to do this automatically.
The script uses kitty&rsquo;s remote control feature to grab text from all other windows in the current tab. To make things simple the script only cares about visible portion of the scrollback buffer, although you could certainly tweak the options to grab the whole buffer."><meta property="og:image" content><meta property="og:title" content="Capture paths from a Kitty window in Neovim"><meta property="og:description" content="Tired of skimming through buffer output, looking for a path? I am! I spent relaxing day at the cottage hacking together a Lua plugin to do this automatically.
The script uses kitty&rsquo;s remote control feature to grab text from all other windows in the current tab. To make things simple the script only cares about visible portion of the scrollback buffer, although you could certainly tweak the options to grab the whole buffer."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.dkendal.com/pages/capture-paths-kitty-neovim/"><meta property="article:section" content="pages"><meta property="article:published_time" content="2022-07-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-25T16:16:30+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Capture paths from a Kitty window in Neovim"><meta name=twitter:description content="Tired of skimming through buffer output, looking for a path? I am! I spent relaxing day at the cottage hacking together a Lua plugin to do this automatically.
The script uses kitty&rsquo;s remote control feature to grab text from all other windows in the current tab. To make things simple the script only cares about visible portion of the scrollback buffer, although you could certainly tweak the options to grab the whole buffer."><script src=https://blog.dkendal.com/js/feather.min.js></script>
<link href=https://blog.dkendal.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://blog.dkendal.com/css/main.40ca3a860425083862b7ebd55447caec5c4384573f0cb098b8d06a91e8dace2e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://blog.dkendal.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-QRNY1HKHWT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QRNY1HKHWT",{anonymize_ip:!1})}</script></head><body><div class=content><header><div class=main><a href=https://blog.dkendal.com/>Digital Janitorial Services</a></div><nav><a href=/>Home</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://blog.dkendal.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Capture paths from a Kitty window in Neovim</h1><div class=meta>Posted on Jul 3, 2022</div></div><section class=body><p>Tired of skimming through buffer output, looking for a path?
I am!
I spent relaxing day at the cottage hacking together a Lua plugin to do this automatically.</p><p>The script uses <a href=https://sw.kovidgoyal.net/kitty/remote-control/#kitty-ls>kitty&rsquo;s remote control</a> feature to grab text from all other windows in the current tab.
To make things simple the script only cares about visible portion of the scrollback buffer, although you could certainly tweak the options to grab the whole buffer.
Likewise, the Vim buffer is updated when it regains focus but it could be improved to act on a timer to respond to updates.</p><figure><img src=/ox-hugo/2022-07-03_15-30-08_screenshot.png alt="Figure 1: The red arrow on the left indicates the path visible in the buffer, the red arrow on the right indicates the virtual text that was added by the lua script to indicate the referenced file path."><figcaption><p>Figure 1: The red arrow on the left indicates the path visible in the buffer, the red arrow on the right indicates the virtual text that was added by the lua script to indicate the referenced file path.</p></figcaption></figure><p>If you&rsquo;re not familiar with writing lua plugins for Neovim this sample has a pretty decent sampling of common operations: creating an auto command, adding highlighted virtual text using extmarks, and working with data from external commands.</p><p>The full source is provided below, to make use of it either plop it in a new file and <code>require(...)</code> from your init.lua or put it in a file under <code>~/.config/nvim/plugin/</code> to have it autoload.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- @alias Process { pid: number }</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@alias KittyWindow { id: number, is_focused: boolean, is_self: boolean, foreground_processes: Process }</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@alias KittyTab { id: number, is_focused: boolean, windows: KittyWindow[] }</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@alias KittyWM { id: number, is_focused: boolean, tabs: KittyTab[] }</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@alias KittyState KittyWM[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> config <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> pid <span style=color:#f92672>=</span> vim.fn.getpid()
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> ns <span style=color:#f92672>=</span> vim.api.nvim_create_namespace(<span style=color:#e6db74>&#34;user-kitty&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> group <span style=color:#f92672>=</span> vim.api.nvim_create_augroup(<span style=color:#e6db74>&#34;user-kitty&#34;</span>, { clear <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>has_support</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> vim.fn.executable(<span style=color:#e6db74>&#34;kitty&#34;</span>) <span style=color:#f92672>and</span> vim.fn.system(<span style=color:#e6db74>&#34;kitty @ ls &gt; /dev/null &amp;&amp; printf &#39;ok&#39;&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;ok&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@param window KittyWindow</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>kitty_is_current_window</span>(window)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> _, ps <span style=color:#66d9ef>in</span> ipairs(window.foreground_processes) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ps.pid <span style=color:#f92672>==</span> pid <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@param state KittyState</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@return KittyTab</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>kitty_get_current_tab</span>(state)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> _, wm <span style=color:#66d9ef>in</span> ipairs(state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> _, tab <span style=color:#66d9ef>in</span> ipairs(wm.tabs) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> _, window <span style=color:#66d9ef>in</span> ipairs(tab.windows) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> kitty_is_current_window(window) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>return</span> tab
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@return KittyState</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>kitty_get_state</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> txt <span style=color:#f92672>=</span> vim.fn.system(<span style=color:#e6db74>&#34;kitty @ ls&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> txt <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> vim.fn.json_decode(txt)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@param id number</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@param opts {}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>---@return string[]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>kitty_get_text</span>(id, opts)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> vim.fn.systemlist(<span style=color:#e6db74>&#34;kitty @ get-text --match id:&#34;</span> <span style=color:#f92672>..</span> id)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>callback</span>()
</span></span><span style=display:flex><span>  vim.api.nvim_buf_clear_namespace(<span style=color:#ae81ff>0</span>, ns, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> state <span style=color:#f92672>=</span> kitty_get_state()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> tab <span style=color:#f92672>=</span> kitty_get_current_tab(state)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> _, window <span style=color:#66d9ef>in</span> ipairs(tab.windows) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> kitty_is_current_window(window) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>local</span> lines <span style=color:#f92672>=</span> kitty_get_text(window.id, {})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> _, line <span style=color:#66d9ef>in</span> ipairs(lines) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;(%S+%.%S+):(%d+):(%d+):&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> path, lnum, col <span style=color:#f92672>=</span> string.match(line, pattern)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> path <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>local</span> bufnr <span style=color:#f92672>=</span> vim.fn.bufnr(path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>if</span> bufnr <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	    vim.api.nvim_buf_set_extmark(bufnr, ns, tonumber(lnum) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, tonumber(col) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, {
</span></span><span style=display:flex><span>	      hl_group <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Search&#34;</span>,
</span></span><span style=display:flex><span>	      virt_text <span style=color:#f92672>=</span> { { <span style=color:#e6db74>&#34;🐱&#34;</span>, <span style=color:#e6db74>&#34;Search&#34;</span> } },
</span></span><span style=display:flex><span>	      virt_text_pos <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eol&#34;</span>,
</span></span><span style=display:flex><span>	      strict <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>	    })
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>init</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> has_support() <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    vim.notify(<span style=color:#e6db74>&#34;Kitty remote control is not enabled or supported, hint: check the output of `kitty @ ls`&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vim.api.nvim_create_autocmd({ <span style=color:#e6db74>&#34;BufEnter&#34;</span> }, {
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Tweak the pattern to enable whatever filetypes you want to support</span>
</span></span><span style=display:flex><span>    pattern <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;*.hs&#34;</span> },
</span></span><span style=display:flex><span>    group <span style=color:#f92672>=</span> group,
</span></span><span style=display:flex><span>    callback <span style=color:#f92672>=</span> callback,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>init()</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/vim>vim</a></li><li><a href=/tags/lua>lua</a></li><li><a href=/tags/plugin>plugin</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://www.linkedin.com/in/dylan-kendal-24027545/ title="Dylan's LinkedIn account"><i data-feather=linkedin></i></a><a class=soc href=https://github.com/Dkendal title="Dylan's GitHub account"><i data-feather=github></i></a></div><div class=footer-info>2022</div></footer><script>feather.replace()</script></div></body></html>